function setDefaultRules(rnd) { setRules(rnd); }
function setRules(rnd)
{
	Array.from(document.querySelectorAll('path.wall')).forEach(path => { path.classList.remove('passable'); });
	Array.from(document.querySelectorAll('g.bridge')).forEach(bridge => { bridge.style.visibility = ''; });

	let cells = [...Array(/*!*/676/*!!*/).keys()];
	let links = [/*@*/[1,4,5,40],[0,2,5,6,53],[1,3,6,7,56],[2,7,8,69],[0,5,9,10],[0,1,4,6,10,11],[1,2,5,7,11,12],[2,3,6,8,12,13],[3,7,13,14,72],[4,10,15,16],[4,5,9,11,16,17],[5,6,10,12,17,18],[6,7,11,13,18,19],[7,8,12,14,19,20],[8,13,20,21,359],[9,16,22],[9,10,15,17,22,23],[10,11,16,18,23,24],[11,12,17,19,24,25],[12,13,18,20,25,26],[13,14,19,21,26,27],[14,20,27,243],[15,16,23,28],[16,17,22,24,28,29],[17,18,23,25,29,30],[18,19,24,26,30,31],[19,20,25,27,31,32],[20,21,26,32,241],[22,23,29,33],[23,24,28,30,33,34],[24,25,29,31,34,35],[25,26,30,32,35,36],[26,27,31,36,239],[28,29,34],[29,30,33,35,233],[30,31,34,36,235],[31,32,35,237],[38,40],[37,39,41,44],[38,40,44,53,54],[0,37,39,53],[38,42,44],[41,43,45,48],[42,44,48,57,58],[38,39,41,43,57],[42,46,48],[45,47,49,52],[46,48,52,61,62],[42,43,45,47,61],[46,50,52],[49,51,119],[50,52,65,66,122],[46,47,49,51,65],[1,39,40,54,56],[39,53,55,57,60],[54,56,60,69,70],[2,53,55,69],[43,44,54,58,60],[43,57,59,61,64],[58,60,64,73,74],[54,55,57,59,73],[47,48,58,62,64],[47,61,63,65,68],[62,64,68,77,78],[58,59,61,63,77],[51,52,62,66,68],[51,65,67,121],[66,68,81,82,137],[62,63,65,67,81],[3,55,56,70,72],[55,69,71,73,76],[70,72,76,85,86],[8,69,71,85],[59,60,70,74,76],[59,73,75,77,80],[74,76,80,89,90],[70,71,73,75,89],[63,64,74,78,80],[63,77,79,81,84],[78,80,84,93,94],[74,75,77,79,93],[67,68,78,82,84],[67,81,83,143],[82,84,97,98,142],[78,79,81,83,97],[71,72,86,88],[71,85,87,89,92],[86,88,92,336],[85,87,245],[75,76,86,90,92],[75,89,91,93,96],[90,92,96,329],[86,87,89,91,337],[79,80,90,94,96],[79,93,95,97,100],[94,96,100,317],[90,91,93,95,316],[83,84,94,98,100],[83,97,99,160],[98,100,371],[94,95,97,99,306],[104,105,106,107],[103,104,120],[102,105,118],[101,102,107,120],[101,103,106,118],[101,105,109,110],[101,104,110,114],[110,111,112,113],[106,111,126,127],[106,107,108,113],[108,109,112,130],[108,111,132,133],[108,110,115,116],[107,115,123,136],[113,114,116,139],[113,115,133,141],[118,125,161],[103,105,117],[50,120,122],[102,104,119],[66,122,123,137],[51,119,121,123],[114,121,122,136],[125,126,128,179],[117,124,126,170],[109,124,125,127],[109,126,129,130],[124,129,135,188],[127,128,130,135],[111,127,129,131],[130,132,146,147],[112,131,133,150],[112,116,132,141],[135,145,206],[128,129,134,197],[114,123,138,139],[67,121,138,143],[136,137,139,143],[115,136,138,140],[139,141,157,159],[116,133,140,151],[83,143,160],[82,137,138,142],[145,146,148,451],[134,144,146,215],[131,144,145,147],[131,146,149,150],[144,149,153,372],[147,148,150,153],[132,147,149,151],[141,150,156,157],[153,155,367],[148,149,152,377],[155,156,158],[152,154,156,366],[151,154,155,157],[140,151,156,159],[154,159,160,307],[140,157,158,160],[98,142,158,159],[117,162,170],[161,163,171],[162,164,172],[163,165,173],[164,166,174],[165,167,175],[166,168,176],[167,169,177],[168,178],[125,161,171,179],[162,170,172,180],[163,171,173,181],[164,172,174,182],[165,173,175,183],[166,174,176,184],[167,175,177,185],[168,176,178,186],[169,177,187],[124,170,180,188],[171,179,181,189],[172,180,182,190],[173,181,183,191],[174,182,184,192],[175,183,185,193],[176,184,186,194],[177,185,187,195],[178,186,196],[128,179,189,197],[180,188,190,198],[181,189,191,199],[182,190,192,200],[183,191,193,201],[184,192,194,202],[185,193,195,203],[186,194,196,204],[187,195,205],[135,188,198,206],[189,197,199,207],[190,198,200,208],[191,199,201,209],[192,200,202,210],[193,201,203,211],[194,202,204,212],[195,203,205,213],[196,204,214],[134,197,207,215],[198,206,208,216],[199,207,209,217],[200,208,210,218],[201,209,211,219],[202,210,212,220],[203,211,213,221],[204,212,214,222],[205,213,223],[145,206,216,224],[207,215,217,225],[208,216,218,226],[209,217,219,227],[210,218,220,228],[211,219,221,229],[212,220,222,230],[213,221,223,231],[214,222,232],[215,225,373],[216,224,226,452],[217,225,227,453],[218,226,228,454],[219,227,229,431],[220,228,230,432],[221,229,231,433],[222,230,232,434],[223,231,435],[34,234,235,246],[233,235,246,248],[35,233,234,236,237,248],[235,237,248,250],[36,235,236,238,239,250],[237,239,250,252],[32,237,238,240,241,252],[239,241,252,254],[27,239,240,242,243,254],[241,243,254,256],[21,241,242,244,245,256],[243,245,256,258],[88,243,244,258],[233,234,247,248,259],[246,248,259,261],[234,235,236,246,247,249,250,261],[248,250,261,263],[236,237,238,248,249,251,252,263],[250,252,263,265],[238,239,240,250,251,253,254,265],[252,254,265,267],[240,241,242,252,253,255,256,267],[254,256,267,269],[242,243,244,254,255,257,258,269],[256,258,269,271],[244,245,256,257,271,334],[246,247,260,261,272],[259,261,272,274],[247,248,249,259,260,262,263,274],[261,263,274,276],[249,250,251,261,262,264,265,276],[263,265,276,278],[251,252,253,263,264,266,267,278],[265,267,278,280],[253,254,255,265,266,268,269,280],[267,269,280,282],[255,256,257,267,268,270,271,282],[269,271,282,284],[257,258,269,270,284,358],[259,260,273,274,285],[272,274,285,287],[260,261,262,272,273,275,276,287],[274,276,287,289],[262,263,264,274,275,277,278,289],[276,278,289,291],[264,265,266,276,277,279,280,291],[278,280,291,293],[266,267,268,278,279,281,282,293],[280,282,293,295],[268,269,270,280,281,283,284,295],[282,284,295,297],[270,271,282,283,297,356],[272,273,286,287,298],[285,287,298,299],[273,274,275,285,286,288,289,299],[287,289,299,300],[275,276,277,287,288,290,291,300],[289,291,300,301],[277,278,279,289,290,292,293,301],[291,293,301,302],[279,280,281,291,292,294,295,302],[293,295,302,303],[281,282,283,293,294,296,297,303],[295,297,303,304],[283,284,295,296,304,365],[285,286,299,455],[286,287,288,298,300,456],[288,289,290,299,301,458],[290,291,292,300,302,460],[292,293,294,301,303,462],[294,295,296,302,304,464],[296,297,303,523],[306,308,310,312,314,316],[100,305,307,317],[158,306,308],[305,307,309,370],[308,310,319],[305,309,311,318],[310,312,327],[305,311,313,338],[312,314,330],[305,313,315,328],[314,316,329],[96,305,315,317],[95,306,316],[310,319,321,323,325,327],[309,318,320,378],[319,321,383],[318,320,322,382],[321,323,381],[318,322,324,593],[323,325,345],[318,324,326,344],[325,327,339],[311,318,326,338],[314,329,330,332,334,336],[91,315,328,337],[313,328,331,338],[330,332,343],[328,331,333,352],[332,334,359],[258,328,333,335],[334,336],[87,328,335,337],[92,329,336],[312,327,330,339,341,343],[326,338,340,344],[339,341,351],[338,340,342,360],[341,343,353],[331,338,342,352],[325,339,345,347,349,351],[324,344,346,401],[345,347,612],[344,346,348,531],[347,349,528],[344,348,350],[349,351,361],[340,344,350,360],[332,343,353,355,357,359],[342,352,354,360],[353,355,365],[352,354,356],[284,355,357],[352,356,358],[271,357,359],[14,333,352,358],[341,351,353,361,363,365],[350,360,362],[361,363,525],[360,362,364,522],[363,365,465],[297,354,360,364],[155,367,371],[152,366,368,376,377],[367,369,376,384,389],[368,370,378,379,389],[308,369,371,378],[99,366,370],[148,373,377],[224,372,374],[373,375,390,395,450],[374,376,384,385,395],[367,368,375,377,384],[153,367,372,376],[319,369,370,379,383],[369,378,380,388,389],[379,381,388,396,401],[322,380,382,401],[321,381,383],[320,378,382],[368,375,376,385,389],[375,384,386,394,395],[385,387,394,402,407],[386,388,396,397,407],[379,380,387,389,396],[368,369,379,384,388],[374,391,395,449],[390,392,448],[391,393,447],[392,394,402,403,446],[385,386,393,395,402],[374,375,385,390,394],[380,387,388,397,401],[387,396,398,406,407],[397,399,406,589],[398,400,594],[399,401,532],[345,380,381,396,400],[386,393,394,403,407],[393,402,404,445],[403,405,642],[404,406,582],[397,398,405,407,581],[386,387,397,402,406],[409,410,411,412,413,418],[408,410,413,414,415],[408,409,415,416,417,418],[408,412,418,419,420,421],[408,411,413,421,422],[408,409,412,414,422,423,424],[409,413,415,424,425],[409,410,414,416,425,426,427],[410,415,417,427,428],[410,416,418,428,429,430],[408,410,411,417,419,430],[411,418,420,430,431,432,454],[411,419,421,432,433,434],[411,412,420,422,434,435,436],[412,413,421,423,436,437,438],[413,422,424,438,439,440],[413,414,423,425,440,441,442],[414,415,424,426,442,443,444],[415,425,427,444,445,446],[415,416,426,428,446,447,448],[416,417,427,429,448,449,450],[417,428,430,450,451,452],[417,418,419,429,452,453,454],[228,419,432,454],[229,419,420,431,433],[230,420,432,434],[231,420,421,433,435],[232,421,434,436],[421,422,435,437],[422,436,438],[422,423,437,439,622],[423,438,440,619],[423,424,439,441,621],[424,440,442,628],[424,425,441,443,630],[425,442,444,640],[425,426,443,445,577],[403,426,444,446],[393,426,427,445,447],[392,427,446,448],[391,427,428,447,449],[390,428,448,450],[374,428,429,449,451],[144,429,450,452],[225,429,430,451,453],[226,430,452,454],[227,419,430,431,453],[298,456,466],[299,455,457],[456,458,468],[300,457,459],[458,460,470],[301,459,461],[460,462,472],[302,461,463],[462,464,474],[303,463,465],[364,464,476],[455,467],[466,468,478],[457,467,469],[468,470,480],[459,469,471],[470,472,482],[461,471,473],[472,474,484],[463,473,475],[474,476,486],[465,475],[478,488],[467,477,479],[478,480,490],[469,479,481],[480,482,492],[471,481,483],[482,484,494],[473,483,485],[484,486,496],[475,485,487],[486,498,536],[477,489],[488,490,500],[479,489,491],[490,492,502],[481,491,493],[492,494,504],[483,493,495],[494,496,506],[485,495,497],[496,498,508],[487,497,549],[500,510],[489,499,501],[500,502,512],[491,501,503],[502,504,514],[493,503,505],[504,506,516],[495,505,507],[506,508,518],[497,507,509],[508,520,563],[499,511],[510,512],[501,511,513],[512,514],[503,513,515],[514,516],[505,515,517],[516,518],[507,517,519],[518,520],[509,519,562],[522,523,526,535],[363,521,523,526],[304,521,522,535],[525,526,529,538],[362,524,526,529],[521,522,524,525,535,538],[528,529,533,541],[348,527,529,533],[524,525,527,528,538,541],[531,532,533,544],[347,530,532,533],[400,530,531,544],[527,528,530,531,541,544],[535,536,539,548],[521,523,526,534,536,539],[487,534,535,548],[538,539,542,551],[524,526,529,537,539,542],[534,535,537,538,548,551],[541,542,546,554],[527,529,533,540,542,546],[537,538,540,541,551,554],[544,545,546,557],[530,532,533,543,545,546],[543,544,557,611],[540,541,543,544,554,557],[548,549,552,561],[534,536,539,547,549,552],[498,547,548,561],[551,552,555,565],[537,539,542,550,552,555],[547,548,550,551,561,565],[554,555,559,569],[540,542,546,553,555,559],[550,551,553,554,565,569],[557,558,559,573],[543,545,546,556,558,559],[556,557,573,610],[553,554,556,557,569,573],[561,562,563,567],[547,549,552,560,563,567],[520,560,563,567],[509,560,561,562],[565,566,567,571],[550,552,555,564,567,571],[564,567,571],[560,561,562,564,565,566],[569,570,571,576],[553,555,559,568,571,576],[568,571,576],[564,565,566,568,569,570],[573,574,575,576],[556,558,559,572,574,576],[572,573,575,617],[572,574,576,616],[568,569,570,572,573,575],[444,578,582],[577,579,588,657],[578,580,587,595],[579,581,590,600],[406,580,582,589],[405,577,581],[584,588,669],[583,585,668],[584,586,601,672],[585,587,596,606],[579,586,588,595],[578,583,587],[398,581,590,594],[580,589,591,600],[590,592,599,607],[591,593,612],[323,592,594],[399,589,593],[579,587,596,600],[586,595,597,606],[596,598,605,613],[597,599,608,618],[591,598,600,607],[580,590,595,599],[585,602,606,671],[601,603,675],[602,604],[603,605,614],[597,604,606,613],[586,596,601,605],[591,599,608,612],[598,607,609,618],[608,610,617],[558,609,611],[545,610,612],[346,592,607,611],[597,605,614,618],[604,613,615],[614,616],[575,615,617],[574,609,616,618],[598,608,613,617],[439,620,621],[619,621,624,631],[440,619,620,628],[438,623,624],[622,624,627,634],[620,622,623,631],[626,627],[625,627,637],[623,625,626,634],[441,621,629,630],[628,630,633,643],[442,628,629,640],[620,624,632,633],[631,633,636,646],[629,631,632,643],[623,627,635,636],[634,636,639,649],[632,634,635,646],[626,638,639],[637,639,652],[635,637,638,649],[443,630,641,642],[640,642,645,655],[404,640,641],[629,633,644,645],[643,645,648,658],[641,643,644,655],[632,636,647,648],[646,648,651,661],[644,646,647,658],[635,639,650,651],[649,651,654,664],[647,649,650,661],[638,653,654],[652,654],[650,652,653,664],[641,645,656,657],[655,657,660,667],[578,655,656],[644,648,659,660],[658,660,663,670],[656,658,659,667],[647,651,662,663],[661,663,666,673],[659,661,662,670],[650,654,665,666],[664,666],[662,664,665,673],[656,660,668,669],[584,667,669,672],[583,667,668],[659,663,671,672],[601,670,672,675],[585,668,670,671],[662,666,674,675],[673,675],[602,671,673,674]/*@@*/];

	// Find a random starting cell
	let startCellIx = rnd.next(0, cells.length);
	let startCell = cells[startCellIx];

	// Maze algorithm starts here
	let todo = [startCell];
	cells.splice(startCellIx, 1);

	function makeTraversible(cell1, cell2)
	{
		let wall = document.getElementById(`wall-${cell1}-${cell2}`) ?? document.getElementById(`wall-${cell2}-${cell1}`);
		let bridge = document.getElementById(`bridge-${cell1}-${cell2}`) ?? document.getElementById(`bridge-${cell2}-${cell1}`);
		if (wall)
			wall.classList.add('passable');
		else if (bridge)
			bridge.style.visibility = 'visible';
	}

	while (cells.length > 0)
	{
		let ix = rnd.next(0, todo.length);
		let cell = todo[ix];

		let availableLinks = links[cell].filter(otherCell => cells.includes(otherCell));
		if (availableLinks.length === 0)
			todo.splice(ix, 1);
		else
		{
			let otherCell = availableLinks[availableLinks.length === 1 ? 0 : rnd.next(0, availableLinks.length)];
			makeTraversible(cell, otherCell);
			cells.splice(cells.indexOf(otherCell), 1);
			todo.push(otherCell);
		}
	}

	let letters = Array(26).fill(null).map((_, c) => String.fromCharCode(65 + c));
	let letterCodes = letters.map(ltr => letters.map(ltr2 => ltr+ltr2)).flat();
	rnd.shuffleFisherYates(letterCodes);
	for (let i = 0; i < 26*26; i++)
		document.getElementById(`cell-label-${i}`).textContent = letterCodes[i];
}

document.addEventListener('DOMContentLoaded', function()
{
	Array.from(document.getElementsByClassName('expand-maze')).forEach(btn =>
	{
		btn.onclick = function()
		{
			let maze = document.getElementById('whole-maze');
			let section = document.getElementsByClassName('section')[0];
			section.parentNode.insertBefore(maze, section);
			section.parentNode.removeChild(section);
			maze.setAttribute('viewBox', '-.5 -.5 37 25');
			maze.style.position = 'fixed';
			maze.style.inset = '0 auto auto 0';
			maze.style.margin = '0';
			maze.style.width = '100vw';
			maze.style.height = '100vh';
			document.body.style.background = document.body.classList.contains('dark') ? '#232323' : 'white';
		};
	});
});
